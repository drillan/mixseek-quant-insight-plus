# Feature Specification: ファイルシステムベース・コード実行環境

**Feature Branch**: `001-fs-code-execution`
**Created**: 2026-02-21
**Status**: Draft
**Input**: User description: "ファイルシステムベース・コード実行環境 — エージェント生成コードをファイルシステムで管理し、Leader LLM によるコード改変を排除する"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - エージェント生成コードの正確な評価 (Priority: P1)

チーム実行において、submission-creator エージェントが生成した Python コードが
Leader LLM を経由する際に要約・省略されることなく、Evaluator に正確に到達する。
現行では Leader がコードを改変・省略するため、Evaluator がコードブロックを抽出できず
評価が失敗している（Issue #32）。

ファイルシステムを介してコードを直接受け渡すことで、コードの完全性を保証する。

**Why this priority**: 本機能の根本的な存在理由。コードが正確に評価されなければ
チーム実行の結果が信頼できない。

**Independent Test**: チーム実行を1ラウンド実行し、submission-creator が生成した
コードと Evaluator が受け取ったコードが完全一致することを検証できる。

**Acceptance Scenarios**:

1. **Given** チーム実行が開始された状態、**When** submission-creator がコードを生成した、**Then** コードはファイルシステム上の所定のラウンドディレクトリに保存される
2. **Given** コードがファイルシステムに保存された状態、**When** コントローラーが Evaluator にコードを渡す、**Then** ファイルから直接読み取ったコードが使用され、Leader の出力テキストは使用されない
3. **Given** Leader がコードを要約・省略して出力した状態、**When** Evaluator がコードを受け取る、**Then** Leader の要約ではなくファイルシステム上の原本コードが渡される
4. **Given** TOML テンプレートに Python 実行コマンドが設定された状態、**When** エージェントのシステム指示が生成される、**Then** 設定された Python コマンドがシステム指示に含まれる
5. **Given** TOML テンプレートに Python 実行コマンドが未設定の状態、**When** エージェントが初期化される、**Then** エラーが送出される

---

### User Story 2 - 同一ラウンド内のエージェント間ファイル共有 (Priority: P2)

同一ラウンド内で、train-analyzer の分析結果が submission-creator の
プロンプトに自動的に埋め込まれ、メンバー間のファイルを通じた情報共有が実現される。

**Why this priority**: 分析結果を正確に共有することで、submission-creator が
より質の高いコードを生成できる。P1の正確な評価基盤の上に成り立つ。

**Independent Test**: ラウンドディレクトリ内に分析結果ファイルを配置した状態で
submission-creator を実行し、プロンプトに分析内容が埋め込まれることを検証できる。

**Acceptance Scenarios**:

1. **Given** ラウンドディレクトリに分析結果ファイルが存在する状態、**When** submission-creator のタスクが開始される、**Then** 分析結果の内容がタスクプロンプトに埋め込まれる
2. **Given** ラウンドディレクトリにファイルが存在しない状態、**When** エージェントのタスクが開始される、**Then** タスクプロンプトはそのまま使用される（エラーにはならない）
3. **Given** ラウンドディレクトリに複数のファイルが存在する状態、**When** エージェントのタスクが開始される、**Then** 全ファイルの内容がプロンプトに埋め込まれる

---

### User Story 3 - セットアップとディレクトリ管理 (Priority: P3)

ユーザーが `qip setup` を実行すると、ワークスペース内にファイルベースの
submissions 管理構造が自動作成される。各ラウンド実行時にはラウンドディレクトリが
自動的に作成される。

**Why this priority**: P1・P2 の前提となるディレクトリ構造の管理。
セットアップ時に一度行えば以降は自動管理される。

**Independent Test**: `qip setup` を実行し、submissions 管理構造が
作成されることを検証できる。

**Acceptance Scenarios**:

1. **Given** ワークスペースが初期化されていない状態、**When** `qip setup` を実行する、**Then** submissions 管理用のディレクトリが作成される
2. **Given** ラウンド実行が開始された状態、**When** ラウンド N の処理が開始される、**Then** 該当ラウンドのディレクトリが自動作成される
3. **Given** ラウンドディレクトリが既に存在する状態、**When** 同じラウンドが再実行される、**Then** ディレクトリ作成は冪等に処理される（エラーにならない）

---

### User Story 4 - upstream パッチのドリフト検出 (Priority: P3)

upstream ライブラリのコントローラーメソッドが更新された場合に、パッチの互換性問題を
自動的に検出し、開発者に通知する。

**Why this priority**: パッチベースの統合はライブラリ更新時に壊れるリスクがある。
自動検出により、問題を早期に発見できる。

**Independent Test**: upstream メソッドのハッシュ値を検証するテストを実行し、
変更があった場合にテストが失敗することを検証できる。

**Acceptance Scenarios**:

1. **Given** upstream メソッドが変更されていない状態、**When** ドリフト検出テストを実行する、**Then** テストが成功する
2. **Given** upstream メソッドが更新された状態、**When** ドリフト検出テストを実行する、**Then** テストが失敗し、パッチの見直しが必要であることが示される

---

### Edge Cases

- submission-creator がコードを生成したがファイルへの書き込みに失敗した場合 → 専用の例外が即座に送出される
- ワークスペース環境変数が未設定の場合 → 明示的なエラーが送出される
- ラウンドディレクトリの作成権限がない場合 → OS レベルのエラーが伝播される
- コード読み取り時にファイルが破損・削除された場合 → エラーステータスが返される
- コードファイルが存在するが空の場合 → コード抽出失敗として評価エラーが返される
- TOML テンプレートに Python 実行コマンドが未設定の場合 → エラーが送出される

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: エージェントが生成したコードはファイルシステム上のラウンドディレクトリに直接保存されなければならない
- **FR-002**: Evaluator へのコード提出は、Leader の出力テキストではなく、ファイルシステムから直接読み取られなければならない
- **FR-003**: エージェントの構造化出力はファイルパスと説明のみを含み、コード本体を含んではならない（コードの二重管理を排除）
- **FR-004**: 分析結果はラウンドディレクトリ内のファイルに保存されなければならない
- **FR-005**: ラウンドディレクトリ内の既存ファイルは、エージェントのタスクプロンプトに自動的に埋め込まれなければならない
- **FR-006**: セットアップコマンドはワークスペース内に submissions 管理用ディレクトリを作成しなければならない
- **FR-007**: ラウンドディレクトリの作成は冪等でなければならない（複数回実行してもエラーにならない）
- **FR-008**: upstream コントローラーメソッドの変更を自動検出する仕組みが存在しなければならない
- **FR-009**: コードファイルが存在しない場合、専用の例外が送出されなければならない
- **FR-010**: ワークスペース環境変数が未設定の場合、明示的なエラーが送出されなければならない
- **FR-011**: Leader へのシステム指示において、最終出力には結果の概要と戦略のみを含めるよう指示しなければならない（注: FR-002 により Evaluator へのコード提出は Leader 出力に依存しないため、本要件の遵守は評価結果に影響しない）
- **FR-012**: エージェントがコードの動作確認を行う際の Python 実行コマンドを、TOML テンプレートの設定値として定義し、エージェントのシステム指示に注入しなければならない

### Key Entities

- **Submission**: エージェントが生成した Python コード。ファイルパスと説明で構成される
- **Analysis**: train-analyzer が生成した分析レポート。ファイルパスとレポート内容で構成される
- **Round Directory**: 各ラウンドのファイルを格納するディレクトリ
- **Workspace**: 全ラウンドのデータを管理するルートディレクトリ

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: チーム実行の全ラウンドにおいて、エージェントが生成したコードと Evaluator が受け取るコードが100%一致する
- **SC-002**: コードファイルが存在しない場合、1秒以内に明示的なエラーが検出される
- **SC-003**: upstream ライブラリの更新時に、パッチ互換性の問題がテスト実行で自動的に検出される
- **SC-004**: ラウンドディレクトリの作成・ファイル読み書きが冪等に動作し、再実行時にエラーが発生しない
- **SC-005**: セットアップコマンドの完了後、ワークスペースにファイルベースの submissions 管理構造が準備されている
- **SC-006**: TOML テンプレートで定義された Python 実行コマンドがエージェントのシステム指示に正しく注入される

## Clarifications

### Session 2026-02-21

- Q: FR-012「システムが指定する手段」の具体的な仕組みは？ → A: TOML テンプレートの設定値として Python コマンドを定義し、システム指示に注入する
- Q: FR-012 の Python コマンド設定が TOML で省略された場合の動作は？ → A: 必須設定とし、未設定時はエラーを送出する

## Assumptions

- 本パッケージには既存ユーザーが存在しないため、後方互換性は考慮しない
- ファイルシステムへの置き換え対象はスクリプト保存用テーブルのみ。リーダーボード、ラウンドステータス等の upstream テーブルは影響しない
- チーム実行はシングルプロセス・逐次実行のため、ファイルシステムのレースコンディションは発生しない
- ワークスペース環境変数は実行前に適切に設定されている前提とする
